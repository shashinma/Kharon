# HTTP Profile - Malleable C2 Configuration

This document provides technical specifications for configuring HTTP listener profiles. The profile defines how client-server communications are handled, including request/response formatting, encryption, encoding, and routing behaviors.

---

## Listener UI

![HTTP GUI Profile](../assets/http-gui-profile.png)

### Domain Rotation Strategies

| Strategy | Description |
|----------|-------------|
| **Random** | Randomly selects a host from the pool for each request |
| **Failover** | Uses primary host until failure, then switches to backup |
| **Round Robin** | Cycles through hosts sequentially |

### Proxy Settings

| Setting | Description |
|---------|-------------|
| **Proxy URL** | HTTP proxy endpoint |
| **Username** | Proxy authentication username |
| **Password** | Proxy authentication password |
| **Use SSL (HTTPS)** | Enable HTTPS connections |
| **SSL Certificate Path** | Path to SSL certificate file |
| **SSL Key Path** | Path to SSL private key file |
| **Upload Profile** | JSON file containing the malleable profile configuration |

---

## Malleable HTTP Profile Structure

The profile uses a JSON structure with an array of callback objects, allowing multiple configurations for different hosts and communication patterns.

### Root Level

```json
{
    "callbacks": [
        { /* callback object 1 */ },
        { /* callback object 2 */ }
    ]
}
```

---

## Callback Object

Each callback object defines the complete communication behavior for a set of hosts.

### Complete Structure Overview

```json
{
    "callbacks": [
        {
            "hosts": ["172.23.60.72:5124", "172.23.60.72:5124"],
            "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
            "server_error": { /* error configuration */ },
            "get": { /* GET request configuration */ },
            "post": { /* POST request configuration */ }
        }
    ]
}
```

### Host Configuration

The `hosts` array defines target servers and ports. A single callback can communicate with multiple servers.

```json
"hosts": ["172.23.60.72:5124", "172.23.60.72:5124"]
```

**Features:**
- Multiple target servers and ports supported
- Can mix different ports across hosts
- Enables redundancy and load distribution

### User Agent

The `user_agent` string is shared across both **GET** and **POST** requests from this callback.

```json
"user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
```

---

## Server Error Configuration

Controls HTTP status codes and error responses for failed or invalid connections.

```json
"server_error": {
    "http_status": 403,
    "response": "{\"status\": 403, \"error\": \"Forbidden\", \"message\": \"Access denied\"}",
    "headers": {
        "Content-Type": "application/json; charset=utf-8"
    }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `http_status` | integer | HTTP status code (403, 404, 500, etc.) |
| `response` | string | Response body sent to client |
| `headers` | object | Headers included in error response |

---

## Request Methods: GET and POST

Each HTTP method has its own independent configuration with separate headers, responses, and route configurations.

### GET Configuration

```json
"get": {
    "server_headers": {
        "Content-Type": "text/html; charset=utf-8",
        "Server": "Apache/2.4.41",
        "Cache-Control": "no-store, no-cache, must-revalidate",
        "X-Powered-By": "Express",
        "X-RateLimit-Limit": "1000",
        "X-RateLimit-Remaining": "998",
        "X-RateLimit-Reset": "1704110400",
        "X-Request-ID": "req_abc123def456"
    },
    "client_headers": {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "Cache-Control": "no-cache"
    },
    "empty_response": "\\x90\\x90\\x90\\x90\\x90",
    "uri": { /* route configurations */ }
}
```

### POST Configuration

```json
"post": {
    "server_headers": {
        "Content-Type": "application/json; charset=utf-8",
        "Server": "Apache/2.4.41",
        "Cache-Control": "no-store, no-cache, must-revalidate",
        "X-Powered-By": "Express",
        "X-RateLimit-Limit": "1000",
        "X-RateLimit-Remaining": "997",
        "X-RateLimit-Reset": "1704110400",
        "X-Request-ID": "req_abc123def456",
        "Location": "https://api.example.com/resource/123"
    },
    "client_headers": {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "Cache-Control": "no-cache"
    },
    "empty_response": "\\x90\\x90\\x90\\x90\\x90",
    "uri": { /* route configurations */ }
}
```

### Headers

| Header Type | Description |
|-------------|-------------|
| `server_headers` | Headers that the server includes in responses to the client |
| `client_headers` | Headers that the client includes in requests to the server |

### Empty Response

The `empty_response` field defines what the server sends when no tasking/data is available.

```json
"empty_response": "\\x90\\x90\\x90\\x90\\x90"
```

- `""` (empty string) - Send nothing
- Can contain custom response bytes **(\xHH)** or strings
- Used when the server has no command or data to transmit

---

## Route Configuration (URI)

Routes define endpoint-specific behaviors. Routes with identical behavior can be grouped together using space-separated paths.

### Route Grouping

```json
"uri": {
    "/route1 /route2": { /* shared configuration */ },
    "/route4": { /* unique configuration */ }
}
```

### Route Configuration Fields

Each route contains output configurations for both server and client communication.

#### Server Output

Controls how the server formats and encodes data sent to the client.

```json
"server_output": {
    "mask": true,
    "format": "base64",
    "cookie": "CK_SRV"
}
```

| Field | Type | Description |
|-------|------|-------------|
| `mask` | boolean | `true` = Apply XOR encryption before encoding; `false` = Direct encoding |
| `format` | string | Encoding format: `base64`, `base32`, `base64url` and `hex` |
| `cookie` | string | (Optional) Send output in cookie with this name (not implemented yet in client output) |
| `header` | string | (Optional) Send output in HTTP header with this name |
| `body` | string | (Optional) Custom body content when output is in header/cookie |

#### Client Output

Controls how the client formats and encodes data sent to the server.

```json
"client_output": {
    "mask": true,
    "format": "base64",
    "prepend": "{\"health\": \"alive\", \"message\": \"",
    "append": "\"}"
}
```

| Field | Type | Description |
|-------|------|-------------|
| `mask` | boolean | Apply XOR encryption before encoding |
| `format` | string | Encoding format: `base64`, `base32`, `base64url` and `hex`) |
| `header` | string | (Optional) Send output in HTTP header with this name |
| `parameter` | string | (Optional) Send output as query/body parameter with this name |
| `prepend` | string | (Optional) Data prepended to the encoded output |
| `append` | string | (Optional) Data appended to the encoded output |

**Output Location Priority:**
1. If `header` is specified → output sent in that HTTP header
2. Else if `parameter` is specified → output sent as parameter
3. Else → output sent in request body (default)

#### Client Parameters

Additional metadata parameters to include in requests.

```json
"client_parameters": [
    {"agent_name": "kharon"},
    {"maded_by": "oblivion"}
]
```

---

## Data Flow and Encryption

### When `mask: true`

```
Original Data (encrypted with Loky)
    ↓
XOR Encryption (symmetric key cipher)
    ↓
Format Encoding (base64/base32/base64url/hex)
    ↓
Output (in header/parameter/body)
```

### When `mask: false`

```
Original Data (encrypted with Loky)
    ↓
Format Encoding (base64/base32/base64url/hex)
    ↓
Output (in header/parameter/body)
```

> **Note:** The raw data is always traffic-encrypted with Loky Encrypt. The `mask` option adds an additional XOR layer.

---

## Complete Profile Example

```json
{
    "callbacks": [
        {
            "hosts": ["172.23.60.72:5124", "172.23.60.72:5124"],
            "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
            "server_error": {
                "http_status": 403,
                "response": "{\"status\": 403, \"error\": \"Forbidden\", \"message\": \"Access denied\"}",
                "headers": {
                    "Content-Type": "application/json; charset=utf-8"
                }
            },
            "get": {
                "server_headers": {
                    "Content-Type": "text/html; charset=utf-8",
                    "Server": "Apache/2.4.41",
                    "Cache-Control": "no-store, no-cache, must-revalidate",
                    "X-Powered-By": "Express",
                    "X-RateLimit-Limit": "1000",
                    "X-RateLimit-Remaining": "998",
                    "X-RateLimit-Reset": "1704110400",
                    "X-Request-ID": "req_abc123def456"
                },
                "client_headers": {
                    "Content-Type": "application/json",
                    "Accept": "application/json",
                    "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
                    "Cache-Control": "no-cache"
                },
                "empty_response": "\\x90\\x90\\x90\\x90\\x90",
                "uri": {
                    "/route4": {
                        "server_output": {"mask": true, "format": "base64", "cookie": "CK_SRV"},
                        "client_output": {"mask": true, "format": "base64"},
                        "client_parameters": [{"agent_name": "kharon"}, {"maded_by": "oblivion"}]
                    }
                }
            },
            "post": {
                "server_headers": {
                    "Content-Type": "application/json; charset=utf-8",
                    "Server": "Apache/2.4.41",
                    "Cache-Control": "no-store, no-cache, must-revalidate",
                    "X-Powered-By": "Express",
                    "X-RateLimit-Limit": "1000",
                    "X-RateLimit-Remaining": "997",
                    "X-RateLimit-Reset": "1704110400",
                    "X-Request-ID": "req_abc123def456",
                    "Location": "https://api.example.com/resource/123"
                },
                "client_headers": {
                    "Content-Type": "application/json",
                    "Accept": "application/json",
                    "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
                    "Cache-Control": "no-cache"
                },
                "empty_response": "\\x90\\x90\\x90\\x90\\x90",
                "uri": {
                    "/route1 /route2": {
                        "server_output": {"mask": false, "format": "base64", "header": "MSG_PP", "body": "{\"status\": 200, \"message\": \"Success\"}"},
                        "client_output": {"mask": true, "format": "base64", "prepend": "{\"health\": \"alive\", \"message\": \"", "append": "\"}"}
                    }
                }
            }
        }
    ]
}
```

### Example Breakdown

**GET `/route4` behavior:**
- Server sends XOR-encrypted, base64-encoded data via cookie named `CK_SRV`
- Client sends XOR-encrypted, base64-encoded data in request body
- Includes parameters: `agent_name=kharon` and `maded_by=oblivion`

**POST `/route1` and `/route2` behavior:**
- Server sends unencrypted, base64-encoded data in header `MSG_PP`
- Server also sends fake body: `{"status": 200, "message": "Success"}`
- Client sends XOR-encrypted, base64-encoded data wrapped as: `{"health": "alive", "message": "<encoded_data>"}`